apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: chaoskube
spec:
  generators:
    - list:
        elements:
          - cluster: eks-demo
            url: https://A580F7DE2A082613969729827EFCBCBF.gr7.ap-northeast-2.eks.amazonaws.com

  template:
    metadata:
      name: "chaoskube-{{cluster}}"
      annotations:
        recipients.argocd-notifications.argoproj.io: slack:noti-argocd-alpha-addon
      labels:
        app.kubernetes.io/instance: "addons-{{cluster}}"
        krmt.io/cluster: "{{cluster}}"
        krmt.io/group: "addons"
    spec:
      project: addons
      destination:
        server: "{{url}}"
        namespace: addon-chaoskube
      source:
        repoURL: https://linki.github.io/chaoskube
        targetRevision: "0.1.0"
        chart: chaoskube
        helm:
          values: |-
            fullnameOverride: chaoskube

            image:
              repository: quay.io/linki/chaoskube
              tag: "v0.21.0"

            chaoskube:
              args:
                # kill a pod every 10 minutes
                interval: "3h"

                # only target pods in the test environment
                labels: "chaoskube=true"

                # only consider pods with this annotation
                annotations: "chaos.alpha.kubernetes.io/enabled=true"

                # exclude all DaemonSet pods
                kinds: "!DaemonSet"

                # exclude all pods in the kube-system namespace
                namespaces: "!kube-system"

                # don't kill anything on weekends
                excluded-weekdays: "Sat,Sun"

                # don't kill anything during the night or at lunchtime
                excluded-times-of-day: "22:00-08:00,11:00-13:00"

                # don't kill anything as a joke or on christmas eve
                excluded-days-of-year: "Apr1,Dec24"

                # let's make sure we all agree on what the above times mean
                timezone: "Asia/Seoul"

                # exclude all pods that haven't been running for at least one hour
                minimum-age: "1h"

                # terminate pods for real: this disables dry-run mode which is on by default
                no-dry-run: ""

      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
