apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: gocd-agent
spec:
  generators:
    - list:
        elements:
          - cluster: eks-demo
            url: https://A580F7DE2A082613969729827EFCBCBF.gr7.ap-northeast-2.eks.amazonaws.com
            values:
              region: "ap-northeast-2"
              rolearn: "arn:aws:iam::314695318048:role/irsa--eks-demo--gocd-agent"
              environment: "kr-alpha-k8s"

  template:
    metadata:
      name: "gocd-agent--{{cluster}}"
      annotations:
        recipients.argocd-notifications.argoproj.io: slack:noti-argocd-alpha-addon
      labels:
        app.kubernetes.io/instance: "addons-{{cluster}}"
        krmt.io/cluster: "{{cluster}}"
        krmt.io/group: "addons"
    spec:
      project: addons
      destination:
        server: "{{url}}"
        namespace: addon-gocd-agent
      source:
        repoURL: git@github.com:daangn/argocd-env-addons.git
        targetRevision: main
        path: charts/gocd-agent
        helm:
          values: |-
            raw:
              resources:
                - apiVersion: v1
                  kind: ServiceAccount
                  metadata:
                    annotations:
                      argocd.argoproj.io/sync-wave: "-1"
                      eks.amazonaws.com/role-arn: "{{values.rolearn}}"
                    name: gocd-agent
            gocd:
              fullnameOverride: gocd-agent
              server:
                enabled: false
              serviceAccount:
                name: gocd-agent
                create: false
              rbac:
                roleRef: cluster-admin
              agent:
                serviceAccount:
                  name: gocd-agent
                env:
                  goServerUrl: https://gocd.kr.krmt.io/go
                  agentAutoRegisterEnvironments: "{{values.environment}}"
                  agentAutoRegisterKey: "0f5c2aa5-6e83-45a1-96b5-08ea2871850d"
                replicaCount: 2
                privileged: true
                image:
                  repository: 314695318048.dkr.ecr.ap-northeast-2.amazonaws.com/daangn/delivery-cli
                  tag: v0.1.11
                persistence:
                  size: 4Gi
                resources:
                  requests:
                    cpu: 1000m
                    memory: 2Gi
                  limits:
                    cpu: 1000m
                    memory: 4Gi

      syncPolicy:
        # automated:
        #   prune: true
        #   selfHeal: true
        syncOptions:
          - CreateNamespace=true
