apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: kiali-server
spec:
  generators:
    - list:
        elements:
          - cluster: eks-demo
            values:
              host: "kiali.bruce.spic.me"

  template:
    metadata:
      name: "kiali-server-{{cluster}}"
      annotations:
        notifications.argoproj.io/subscribe.on-sync-succeeded.slack: noti-argocd-alpha-addon
      labels:
        app.kubernetes.io/instance: "addons-{{cluster}}"
        krmt.io/cluster: "{{cluster}}"
        krmt.io/group: "addons"
    spec:
      project: default
      destination:
        name: "{{cluster}}"
        namespace: istio-system
      source:
        repoURL: https://kiali.org/helm-charts
        targetRevision: "v1.39.0"
        chart: kiali-server
        helm:
          values: |-
            fullnameOverride: kiali-server

            auth:
              openid: {}
              strategy: "anonymous"

            deployment:
              pod_labels:
                sidecar.istio.io/inject: "false"
              accessible_namespaces:
              - '**'

            # login_token:
            #   signing_key: CHANGEME

            # server:
            #   web_fqdn: "{{values.host}}"

      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
